'use strict';var chunkSUTBUN3F_cjs=require('../chunk-SUTBUN3F.cjs'),chunkQVAO4WBE_cjs=require('../chunk-QVAO4WBE.cjs'),github=require('@actions/github'),path=require('path');function M(r,o){return r?.length?o.every(({name:e,emailPrefix:s})=>r.some(t=>e&&t.name===e||s&&t.emailPrefix===s)):false}function I(r,o){return o.filter(({name:e,emailPrefix:s})=>!r.some(t=>e&&t.name===e||s&&t.emailPrefix===s))}function T(r,o,e,s){let{caporegimes:t=[],rules:i=[]}=e,n=process.cwd();if(!M(t,o))for(let l of i){if(chunkSUTBUN3F_cjs.d(r,l.match,n).length===0)continue;let f=[...t,...l.goodfellas||[]];if(l.crews&&e.crews){let a=l.crews.flatMap(u=>e.crews?.[u]).filter(Boolean);f.push(...a);}let C=M(f,o),m=!!l.allowForgiveness;if(!C&&!m){let a=I(l.goodfellas,o);throw s&&chunkSUTBUN3F_cjs.c(chunkQVAO4WBE_cjs.c.error),new Error(chunkSUTBUN3F_cjs.a("error",{goodfellas:f,commiters:a}))}}}var v=class r{octokit;constructor(){this.octokit=github.getOctokit(process.env.GITHUB_TOKEN||"");}static init(){return new r}getUniqueCommitersList(o){return o.reduce((e,{commit:s,committer:t})=>{let i=t?.login,n=chunkSUTBUN3F_cjs.e(s.author?.email);if(!i&&!n)return e;if(!(e.nameMap.has(i)||e.emailMap.has(n))){let l={name:i,emailPrefix:n};i&&e.nameMap.add(i),n&&e.emailMap.add(n),e.list.push(l);}return e},{nameMap:new Set,emailMap:new Set,list:[]}).list}async getCommitters(o,e=true){let{data:s}=await this.octokit.rest.pulls.listCommits({owner:github.context.repo.owner,repo:github.context.repo.repo,pull_number:o});if(!s.length)throw new Error("No commits found in this pull request.");let t=e?s:[s[0]],i=this.getUniqueCommitersList(t);if(i.length===0)throw new Error("No email or username found in commit authors metadata.");return i}getPullRequestID(){let o=github.context.payload?.pull_request?.number;return o||(console.log(chunkQVAO4WBE_cjs.c.error,"No pull request number found."),process.exit(1)),o}async getModifiedFiles(o){let{data:e}=await this.octokit.rest.pulls.listFiles({owner:github.context.repo.owner,repo:github.context.repo.repo,pull_number:o});return e.map(s=>path.resolve(s.filename))}getRelevantReviewers(o,e,s){let{caporegimes:t=[],rules:i=[]}=s,n=s.codeReviews?.autoAssignCaporegimes?t:[],d=[],l=process.cwd();for(let m of o){let a=i.find(u=>chunkSUTBUN3F_cjs.d([m],u.match,l).length>0);a&&(a.crews&&d.push(...a.crews),n.push(...a.goodfellas||[]));}let G=n.filter(({name:m,emailPrefix:a})=>!e.some(u=>m&&u.name===m||a&&u.emailPrefix===a)),f=[...new Set(G.map(({name:m})=>m).filter(Boolean))],C=[...new Set(d)];return {reviewers:f,crews:C}}async assignReviewers(o,e,s,t){let{reviewers:i,crews:n}=this.getRelevantReviewers(e,s,t);if(i.length!==0)return await this.octokit.rest.pulls.requestReviewers({owner:github.context.repo.owner,repo:github.context.repo.repo,pull_number:o,reviewers:i,...n.length>0?{team_reviewers:n}:{}})}};(async()=>{try{console.log("process.env.GITHUB_ACTIONS",process.env.GITHUB_ACTIONS),console.log("process.env.CI",process.env.CI),!process.env.CI&&process.env.GITHUB_ACTIONS!=="true"&&(console.log("\u{10102} This script is intended to run inside GitHub Actions."),process.exit(1)),process.env.GITHUB_TOKEN||(console.log(chunkQVAO4WBE_cjs.c.error,"\u{10102} GITHUB_TOKEN is missing. Make sure it's passed via `env:` in your workflow."),process.exit(1));let r=await chunkSUTBUN3F_cjs.b(),o=r.options?.showAscii??!0,e=v.init(),s=e.getPullRequestID(),t=await e.getCommitters(s,r.options?.vouchForAllCommiters),i=await e.getModifiedFiles(s);T(i,t,r,o),((r.codeReviews?.autoAssignGoodfellas??!0)||r.codeReviews?.autoAssignCaporegimes)&&await e.assignReviewers(s,i,t,r),o&&chunkSUTBUN3F_cjs.c(chunkQVAO4WBE_cjs.c.success),console.log(chunkSUTBUN3F_cjs.a("success",{commiters:t})),process.exit(0);}catch(r){let o=r instanceof Error?r.message:String(r);console.log(chunkQVAO4WBE_cjs.c.error,o),process.exit(1);}})();